<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4SP - CONNECT</title>
    <meta name="description" content="Connect your local 4SP client to the organization database.">
    <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin-allow-popups">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <script src="../navigation-mini.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        // Silence noisy extension/COOP warnings
        (function() {
            const oE = console.error; const oW = console.warn;
            console.error = (...a) => { if (a[0]?.includes?.('browser-polyfill') || a[0]?.includes?.('object Object')) return; oE.apply(console, a); };
            console.warn = (...a) => { if (a[0]?.includes?.('cdn.tailwindcss.com') || a[0]?.includes?.('Cross-Origin-Opener-Policy')) return; oW.apply(console, a); };
        })();

        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'custom-darkest': '#040404',
                        'custom-dark': '#111111',
                        'custom-medium': '#252525',
                        'custom-light': '#505050',
                        'custom-lighter': '#808080',
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Geist', sans-serif; background-color: #000000; color: white; }
        .glass-box { background-color: #111111; border: 1px solid #252525; border-radius: 1.5rem; }
        .input-field { background-color: #0c0c0c; border: 1px solid #252525; color: white; border-radius: 0.75rem; width: 100%; padding: 0.75rem 1rem; transition: border-color 0.2s; }
        .input-field:focus { border-color: #0070f3; outline: none; }
        .btn-provider { background-color: #181818; border: 1px solid #252525; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 0.75rem; padding: 0.75rem; border-radius: 0.75rem; width: 100%; }
        .btn-provider:hover { background-color: #252525; transform: translateY(-1px); }
        .btn-primary { background-image: linear-gradient(90deg, #0070f3, #f81ce5); border-radius: 0.75rem; padding: 0.75rem; font-weight: 500; text-align: center; width: 100%; transition: opacity 0.2s; }
        .btn-primary:hover { opacity: 0.9; }
        .btn-dv-download { background: rgba(147, 51, 234, 0.1); border: 1px solid rgba(192, 132, 252, 0.3); color: #c084fc; border-radius: 0.75rem; padding: 1rem; text-align: center; width: 100%; display: flex; align-items: center; justify-content: center; gap: 0.75rem; transition: all 0.2s; }
        .btn-dv-download:hover { background: rgba(147, 51, 234, 0.2); border-color: rgba(192, 132, 252, 1); color: white; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div id="navbar-container"></div>

    <main class="flex-grow flex items-center justify-center p-6 mt-12">
        <div class="max-w-md w-full glass-box p-8 space-y-6">
            
            <div class="text-center space-y-2">
                <h1 class="text-3xl font-light tracking-tight">4SP - CONNECT</h1>
                <p class="text-custom-lighter text-sm font-light">Link your local client to the 4SP Database.</p>
            </div>

            <div id="auth-panel" class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <button id="googleBtn" class="btn-provider"><i class="fab fa-google"></i></button>
                    <button id="githubBtn" class="btn-provider"><i class="fab fa-github"></i></button>
                    <button id="microsoftBtn" class="btn-provider"><i class="fab fa-microsoft"></i></button>
                    <button id="twitterBtn" class="btn-provider"><i class="fab fa-x-twitter"></i></button>
                </div>

                <div class="relative py-2">
                    <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-custom-medium"></div></div>
                    <div class="relative flex justify-center text-xs uppercase"><span class="bg-custom-dark px-2 text-custom-light">OR EMAIL</span></div>
                </div>

                <div class="space-y-3">
                    <input type="email" id="email" placeholder="Email Address" class="input-field">
                    <input type="password" id="password" placeholder="Password" class="input-field">
                    <button id="loginBtn" class="btn-primary">Connect Account</button>
                </div>
                
                <p class="text-center text-xs text-custom-light">
                    No account? <button id="showRegister" class="text-purple-400 hover:underline">Create a 4SP ID</button>
                </p>
            </div>

            <div id="register-panel" class="hidden space-y-4">
                <h2 class="text-xl font-light text-center">New Organization ID</h2>
                <input type="text" id="reg-username" placeholder="Choose a Username" class="input-field">
                <input type="email" id="reg-email" placeholder="Email Address" class="input-field">
                <input type="password" id="reg-password" placeholder="Create Password" class="input-field">
                <button id="doRegister" class="btn-primary">Create and Connect</button>
                <button id="backToLogin" class="w-full text-xs text-custom-light hover:text-white">Back to connection</button>
            </div>

            <div id="connected-panel" class="hidden space-y-6">
                <div class="flex items-center gap-4 bg-black/40 p-4 rounded-2xl border border-custom-medium">
                    <div id="u-avatar" class="w-14 h-14 rounded-full bg-custom-medium flex items-center justify-center overflow-hidden text-xl"></div>
                    <div>
                        <h2 id="u-name" class="font-medium">User</h2>
                        <p id="u-email" class="text-xs text-custom-lighter"></p>
                    </div>
                </div>

                <div class="space-y-3">
                    <label class="text-[10px] uppercase tracking-widest text-custom-light font-bold">Local Client</label>
                    <a href="../4simpleproblems_dv.html" class="btn-dv-download">
                        <i class="fas fa-cloud-arrow-down"></i> Download 4SP DV Client
                    </a>
                </div>

                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <label class="text-[10px] uppercase tracking-widest text-custom-light font-bold">Access Code</label>
                        <span class="text-[10px] bg-green-500/10 text-green-400 px-2 py-0.5 rounded uppercase font-bold">Connected</span>
                    </div>
                    <div class="flex items-center justify-between bg-custom-darkest rounded-xl p-4 border border-custom-medium">
                        <span id="current-code" class="font-mono text-purple-400">Loading...</span>
                        <div class="flex gap-1 text-custom-light">
                            <button id="copyCode" class="p-2 hover:text-white"><i class="fas fa-copy"></i></button>
                            <button id="genCode" class="p-2 hover:text-white"><i class="fas fa-sync-alt"></i></button>
                        </div>
                    </div>
                </div>

                <button id="logoutBtn" class="w-full border border-red-900/20 text-red-500/80 hover:bg-red-900/20 py-3 rounded-xl transition text-sm">Disconnect</button>
            </div>

            <div id="status-msg" class="text-center text-xs font-light"></div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, GithubAuthProvider, TwitterAuthProvider, OAuthProvider, signInWithEmailAndPassword, createUserWithEmailAndPassword, sendEmailVerification, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, getDoc, setDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAZBKAckVa4IMvJGjcyndZx6Y1XD52lgro",
            authDomain: "project-zirconium.firebaseapp.com",
            projectId: "project-zirconium",
            storageBucket: "project-zirconium.firebasestorage.app",
            messagingSenderId: "1096564243475",
            appId: "1:1096564243475:web:6d0956a70125eeea1ad3e6"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const panels = {
            auth: document.getElementById('auth-panel'),
            reg: document.getElementById('register-panel'),
            connected: document.getElementById('connected-panel')
        };

        function showStatus(txt, isError = false) {
            const msg = document.getElementById('status-msg');
            msg.textContent = txt;
            msg.className = `text-center text-xs font-light ${isError ? 'text-red-400' : 'text-purple-400'}`;
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Ensure record exists in DB
                const userRef = doc(db, "users", user.uid);
                const snap = await getDoc(userRef);

                if (!snap.exists()) {
                    // New user from Social Login without a DB record - redirect to registration style username prompt
                    panels.auth.classList.add('hidden');
                    panels.reg.classList.remove('hidden');
                    document.getElementById('reg-email').value = user.email;
                    document.getElementById('reg-email').disabled = true;
                    showStatus("Please complete your profile.");
                    return;
                }

                // Show Dashboard
                panels.auth.classList.add('hidden');
                panels.reg.classList.add('hidden');
                panels.connected.classList.remove('hidden');

                document.getElementById('u-name').textContent = snap.data().username || user.displayName || 'Member';
                document.getElementById('u-email').textContent = user.email;
                const avatar = document.getElementById('u-avatar');
                avatar.innerHTML = user.photoURL ? `<img src="${user.photoURL}" class="w-full h-full object-cover">` : `<i class="fas fa-user text-custom-light"></i>`;

                onSnapshot(userRef, (d) => {
                    document.getElementById('current-code').textContent = d.data()?.code || 'None';
                });

            } else {
                panels.connected.classList.add('hidden');
                panels.auth.classList.remove('hidden');
            }
        });

        // Provider Auth
        async function popAuth(provider) {
            try { await signInWithPopup(auth, provider); } catch(e) { showStatus(e.message, true); }
        }

        document.getElementById('googleBtn').onclick = () => popAuth(new GoogleAuthProvider());
        document.getElementById('githubBtn').onclick = () => popAuth(new GithubAuthProvider());
        document.getElementById('twitterBtn').onclick = () => popAuth(new TwitterAuthProvider());
        document.getElementById('microsoftBtn').onclick = () => popAuth(new OAuthProvider('microsoft.com'));

        // Email Auth
        document.getElementById('loginBtn').onclick = async () => {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            try { await signInWithEmailAndPassword(auth, e, p); } catch(e) { showStatus("Check credentials.", true); }
        };

        // Registration
        document.getElementById('doRegister').onclick = async () => {
            const user = auth.currentUser;
            const username = document.getElementById('reg-username').value;
            
            if (username.length < 3) return showStatus("Username too short", true);

            try {
                let uid = user?.uid;
                if (!user) {
                    const e = document.getElementById('reg-email').value;
                    const p = document.getElementById('reg-password').value;
                    const cred = await createUserWithEmailAndPassword(auth, e, p);
                    uid = cred.user.uid;
                    await sendEmailVerification(cred.user);
                }
                
                await setDoc(doc(db, "users", uid), {
                    username: username,
                    email: user?.email || document.getElementById('reg-email').value,
                    createdAt: serverTimestamp(),
                    code: '4SP-' + Math.random().toString(36).substring(2, 12).toUpperCase()
                });
                location.reload();
            } catch(e) { showStatus(e.message, true); }
        };

        // Access Code Utilities
        document.getElementById('genCode').onclick = async () => {
            const code = '4SP-' + Math.random().toString(36).substring(2, 12).toUpperCase();
            await updateDoc(doc(db, "users", auth.currentUser.uid), { code });
        };

        document.getElementById('copyCode').onclick = () => {
            navigator.clipboard.writeText(document.getElementById('current-code').textContent);
            showStatus("Code Copied!");
        };

        document.getElementById('logoutBtn').onclick = () => signOut(auth);
        document.getElementById('showRegister').onclick = () => { panels.auth.classList.add('hidden'); panels.reg.classList.remove('hidden'); };
        document.getElementById('backToLogin').onclick = () => { panels.reg.classList.add('hidden'); panels.auth.classList.remove('hidden'); };

    </script>
</body>
</html>
